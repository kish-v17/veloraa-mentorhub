<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Video Chat (Code-based Connection)</title>
    <style>
        video {
            width: 300px;
            height: 200px;
        }
        input {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>WebRTC Video Chat (Code-based Connection)</h1>

    <!-- Section for initiating a call -->
    <div>
        <button id="startButton">Start Call</button>
        <p>Your call code: <span id="callCode"></span></p>
    </div>

    <!-- Section for joining a call -->
    <div>
        <input type="text" id="codeInput" placeholder="Enter 5-letter code">
        <button id="joinButton">Join Call</button>
    </div>

    <!-- Video Elements -->
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>

    <script>
        let peerConnection;
        let localStream;
        const configuration = { 
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        };

        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');

        const startButton = document.getElementById('startButton');
        const joinButton = document.getElementById('joinButton');
        const callCodeElement = document.getElementById('callCode');
        const codeInput = document.getElementById('codeInput');

        let callCode = '';

        // Helper function to generate a 5-letter random code
        function generateCallCode() {
            return Math.random().toString(36).substr(2, 5).toUpperCase();
        }

        // Function to start a call
        async function startCall() {
            callCode = generateCallCode();
            callCodeElement.textContent = callCode;

            // Get local media stream (video/audio)
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            localVideo.srcObject = localStream;

            // Create RTCPeerConnection
            peerConnection = new RTCPeerConnection(configuration);
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            // Handle ICE candidates
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    sendSignalingData({
                        candidate: event.candidate,
                        code: callCode
                    });
                }
            };

            // Handle remote stream
            peerConnection.ontrack = event => {
                remoteVideo.srcObject = event.streams[0];
            };

            // Create SDP offer
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);

            // Send offer to server
            sendSignalingData({
                sdp: peerConnection.localDescription,
                code: callCode
            });
        }

        // Function to join a call with a code
        async function joinCall() {
            const enteredCode = codeInput.value.toUpperCase();
            callCode = enteredCode;

            // Get signaling data from the server
            const response = await fetch(`signaling.php?code=${callCode}`);
            const signalingData = await response.json();

            if (signalingData.sdp) {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;

                peerConnection = new RTCPeerConnection(configuration);
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                peerConnection.onicecandidate = event => {
                    if (event.candidate) {
                        sendSignalingData({
                            candidate: event.candidate,
                            code: callCode
                        });
                    }
                };

                peerConnection.ontrack = event => {
                    remoteVideo.srcObject = event.streams[0];
                };

                await peerConnection.setRemoteDescription(new RTCSessionDescription(signalingData.sdp));

                if (signalingData.sdp.type === 'offer') {
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    sendSignalingData({
                        sdp: peerConnection.localDescription,
                        code: callCode
                    });
                }

                // Add any existing ICE candidates
                if (signalingData.ice) {
                    signalingData.ice.forEach(candidate => {
                        peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                    });
                }
            } else {
                alert('Invalid code or no active call.');
            }
        }

        // Function to send signaling data (SDP or ICE candidates)
        async function sendSignalingData(data) {
            await fetch('signaling.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        }

        startButton.addEventListener('click', startCall);
        joinButton.addEventListener('click', joinCall);
    </script>
</body>
</html>
